DESARROLLO

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ATENCIÓN: MODO DE DESARROLLO
    // Estas reglas permiten que CUALQUIER usuario autenticado
    // pueda leer y escribir en TODA la base de datos.
    // NO USAR EN PRODUCCIÓN.
    
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}

--------------
PRODUCCIÓN

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNCIÓN HELPER ---
    function isSuperAdmin() {
      return request.auth != null && 
             get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'superadmin';
    }

    // --- REGLAS SEGURAS (FINALES) ---

    // (Usuarios, Plantillas, Festivales, etc. se quedan igual que antes)
    match /usuarios/{userId} {
      allow read, write: if isSuperAdmin() || (request.auth != null && request.auth.uid == userId);
    }
    match /plantillaEvaluacion/{docId} {
      allow read: if request.auth != null; 
      allow write: if isSuperAdmin();
    }
    match /plantillasPenalizacion/{docId} {
      allow read: if request.auth != null;
      allow write: if isSuperAdmin();
    }
    match /festivales/{docId} {
      allow read: if request.auth != null;
      allow write: if isSuperAdmin();
    }
    match /penalizacionesAplicadas/{docId} {
      allow read, write: if isSuperAdmin();
    }
    
    // --- REGLA FINAL PARA EVALUACIONES ---
    // Esta regla combina la simplicidad de la prueba
    // con la seguridad de la lógica de roles.

    match /evaluaciones/{evalId} {
      
      // LEER (get y list):
      // Un juez puede leer (get/list) CUALQUIER evaluación.
      // Y un admin también.
      // (Esto soluciona AMBOS errores: el de la página y el del formulario)
      allow read: if request.auth != null;

      // ESCRIBIR (create, update):
      // Solo puedes escribir si:
      allow write: if
        // 1. Eres un SuperAdmin
        isSuperAdmin() ||
        // 2. O si el 'juezId' en el NUEVO documento es el tuyo.
        (request.auth != null && request.resource.data.juezId == request.auth.uid);
    }
  }
}