DESARROLLO

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ATENCIÓN: MODO DE DESARROLLO
    // Estas reglas permiten que CUALQUIER usuario autenticado
    // pueda leer y escribir en TODA la base de datos.
    // NO USAR EN PRODUCCIÓN.
    
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}

--------------
PRODUCCIÓN

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNCIÓN HELPER ---
    function isSuperAdmin() {
      return request.auth != null && 
             get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.rol == 'superadmin';
    }

    // --- REGLAS SEGURAS (PARA CASI TODO) ---

    match /usuarios/{userId} {
      allow read, write: if isSuperAdmin() || (request.auth != null && request.auth.uid == userId);
    }
    match /plantillaEvaluacion/{docId} {
      allow read: if request.auth != null; 
      allow write: if isSuperAdmin();
    }
    match /plantillasPenalizacion/{docId} {
      allow read: if request.auth != null;
      allow write: if isSuperAdmin();
    }
    match /festivales/{docId} {
      allow read: if request.auth != null;
      allow write: if isSuperAdmin();
    }
    match /penalizacionesAplicadas/{docId} {
      allow read, write: if isSuperAdmin();
    }
    
    // --- REGLA DE DEPURACIÓN SOLO PARA EVALUACIONES ---
    // Esto nos permite confirmar que el problema está aislado
    // únicamente en esta colección.
    match /evaluaciones/{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}